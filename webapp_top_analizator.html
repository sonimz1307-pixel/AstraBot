<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Top Analizator (Admin)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#0b0f17;color:#e7eaf0}
    h1{font-size:18px;margin:0 0 12px 0}
    .card{background:#111a2b;border:1px solid #1c2a44;border-radius:12px;padding:12px;margin:12px 0}
    label{display:block;font-size:12px;opacity:.9;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #243554;background:#0b1220;color:#e7eaf0}
    button{padding:10px 12px;border:0;border-radius:10px;background:#2d6cdf;color:white;font-weight:600;cursor:pointer}
    button.secondary{background:#22314d}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:160px}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid #1c2a44;padding:8px;text-align:left;vertical-align:top}
    tr:hover{background:#0f1626}
    .muted{opacity:.8}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#22314d}
    .ok{background:#1e5d3b}
    .fail{background:#6a2b2b}
    .queued{background:#5b4a1f}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid #243554;border-radius:10px;padding:10px;max-height:280px;overflow:auto}
    a{color:#7fb2ff}
  </style>
</head>
<body>
  <h1>üèÜ Top Analizator (Admin)</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Admin token (X-Admin-Token)</label>
        <input id="token" placeholder="–≤—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω" type="password"/>
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px">
        <button class="secondary" id="saveToken">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="secondary" id="loadJobs">–û–±–Ω–æ–≤–∏—Ç—å jobs</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">–¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</div>
  </div>

  <div class="card">
    <h1>–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞</h1>
    <div class="row">
      <div>
        <label>–ì–æ—Ä–æ–¥</label>
        <input id="city" value="–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å"/>
      </div>
      <div>
        <label>–ù–∏—à–∞</label>
        <input id="niche" value="—à–∫–æ–ª–∞ —Ç–∞–Ω—Ü–µ–≤"/>
      </div>
      <div>
        <label>Limit</label>
        <input id="limit" type="number" value="5" min="1" max="100"/>
      </div>
      <div>
        <label>Yandex retries</label>
        <input id="yandex_retries" type="number" value="0" min="0" max="5"/>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px">
      <button id="runJob">Run job</button>
      <button class="secondary" id="openLastJob" disabled>–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π job</button>
    </div>
    <div id="runOut" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h1>Jobs</h1>
    <table id="jobsTable">
      <thead>
        <tr>
          <th>Updated</th>
          <th>Status</th>
          <th>City / Query</th>
          <th>Progress</th>
          <th>Job ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h1>Job detail</h1>
    <label>Job ID</label>
    <input id="jobId" placeholder="–≤—Å—Ç–∞–≤—å job_id –∏ –Ω–∞–∂–º–∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å"/>
    <div style="margin-top:10px;display:flex;gap:10px">
      <button id="loadJob">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button class="secondary" id="loadJobWithRaw">+ raw</button>
    </div>

    <div style="margin-top:12px">
      <div class="muted">State</div>
      <pre id="statePre">{}</pre>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Places (mi_places)</div>
      <pre id="placesPre">[]</pre>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Raw items (mi_raw_items)</div>
      <pre id="rawPre">[]</pre>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  function getToken(){
    return ($("token").value || localStorage.getItem("admin_token") || "").trim();
  }
  function setToken(t){
    localStorage.setItem("admin_token", t);
    $("token").value = t;
  }
  function hdr(){
    const t = getToken();
    return t ? {"X-Admin-Token": t} : {};
  }
  function fmtStatus(s){
    const cls = (s==="done"||s==="completed")?"ok":(s==="failed"?"fail":"queued");
    return `<span class="pill ${cls}">${s||"?"}</span>`;
  }

  async function api(path, opts={}){
    const r = await fetch(path, {
      ...opts,
      headers: {...(opts.headers||{}), ...hdr(), "Content-Type":"application/json"},
    });
    const text = await r.text();
    let data;
    try{ data = JSON.parse(text); }catch(e){ data = {raw:text}; }
    if(!r.ok){
      throw new Error((data && (data.detail||data.message)) ? (data.detail||data.message) : ("HTTP "+r.status));
    }
    return data;
  }

  $("saveToken").onclick = ()=> setToken(getToken());
  // preload token
  setToken(localStorage.getItem("admin_token") || "");

  let lastJobId = null;

  $("runJob").onclick = async ()=>{
    $("runOut").textContent = "–ó–∞–ø—É—Å–∫–∞—é...";
    try{
      const payload = {
        tg_user_id: 1,
        city: $("city").value,
        niche: $("niche").value,
        limit: parseInt($("limit").value || "5", 10),
        yandex_retries: parseInt($("yandex_retries").value || "0", 10),
      };
      const res = await api("/api/admin/run_job", {method:"POST", body: JSON.stringify(payload)});
      lastJobId = res.job_id || res.id || res.jobId;
      $("runOut").innerHTML = `‚úÖ job_id: <b>${lastJobId}</b>`;
      $("openLastJob").disabled = !lastJobId;
      if(lastJobId){ $("jobId").value = lastJobId; }
      await loadJobs();
    }catch(e){
      $("runOut").textContent = "‚ùå " + e.message;
    }
  };

  $("openLastJob").onclick = ()=>{
    if(lastJobId){ $("jobId").value = lastJobId; }
    loadJob(false);
  };

  async function loadJobs(){
    const tbody = $("jobsTable").querySelector("tbody");
    tbody.innerHTML = `<tr><td colspan="5" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>`;
    try{
      const res = await api("/api/admin/jobs?limit=50");
      const items = res.items || [];
      if(!items.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(it=>{
        const meta = it.meta || {};
        const phase = meta.phase ? ` ¬∑ ${meta.phase}` : "";
        const prog = `${it.done||0}/${it.total||0} ¬∑ fail ${it.failed||0}${phase}`;
        const q = it.query || (Array.isArray(it.queries) ? it.queries.join(", ") : "");
        return `<tr data-job="${it.job_id}">
          <td>${(it.updated_at||"").replace("T"," ").slice(0,19)}</td>
          <td>${fmtStatus(it.status)}</td>
          <td>${it.city||""}<div class="muted">${q}</div></td>
          <td>${prog}</td>
          <td><a href="#" data-open="${it.job_id}">${it.job_id}</a></td>
        </tr>`;
      }).join("");
      tbody.querySelectorAll("a[data-open]").forEach(a=>{
        a.onclick = (ev)=>{
          ev.preventDefault();
          const jid = a.getAttribute("data-open");
          $("jobId").value = jid;
          loadJob(false);
        };
      });
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="5">‚ùå ${e.message}</td></tr>`;
    }
  }

  async function loadJob(withRaw){
    const jid = ($("jobId").value || "").trim();
    if(!jid){ return; }
    $("statePre").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    $("placesPre").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    $("rawPre").textContent = "[]";
    try{
      const url = withRaw ? `/api/admin/job/${encodeURIComponent(jid)}?include_raw=1&raw_limit=80`
                          : `/api/admin/job/${encodeURIComponent(jid)}?include_raw=0`;
      const res = await api(url);
      $("statePre").textContent = JSON.stringify(res.state || {}, null, 2);
      $("placesPre").textContent = JSON.stringify(res.places || [], null, 2);
      $("rawPre").textContent = JSON.stringify(res.raw_items || [], null, 2);
    }catch(e){
      $("statePre").textContent = "‚ùå " + e.message;
      $("placesPre").textContent = "[]";
      $("rawPre").textContent = "[]";
    }
  }

  $("loadJobs").onclick = loadJobs;
  $("loadJob").onclick = ()=>loadJob(false);
  $("loadJobWithRaw").onclick = ()=>loadJob(true);

  // initial
  loadJobs();
</script>
</body>
</html>
