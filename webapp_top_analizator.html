<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AstraBot</title>
  <style>
    :root{
      --bg0:#060a14;
      --bg1:#0b1220;
      --card1:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.03);
      --br:rgba(255,255,255,.10);
      --txt:#e6edf3;
      --mut:#9fb1c1;
      --ok:#7ee787;
      --bad:#ff6b6b;
      --accent:rgba(255,255,255,.65);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 26px rgba(0,0,0,.35);
      --r: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(64,106,255,.26), transparent 60%),
        radial-gradient(700px 420px at 95% 10%, rgba(0,255,204,.12), transparent 55%),
        radial-gradient(600px 420px at 60% 110%, rgba(255,0,153,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{max-width:760px; margin:0 auto; padding:16px 14px 26px;}
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:6px 2px 4px;
    }
.brand{
      display:flex; gap:10px; align-items:center;
    }
.logo{
      width:30px; height:30px; border-radius:10px;
      display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid var(--br);
      box-shadow: var(--shadow2);
      flex:0 0 auto;
      font-size:16px;
    }
h1{
      font-size:20px;
      font-weight:700;
      line-height:1.2;
      margin:0;
      letter-spacing:.3px;
    }
.subtitle{
      margin:2px 0 0;
      color:rgba(159,177,193,.8);
      font-size:12px;
      max-width:260px;
    }
.top-actions{display:flex; gap:10px; align-items:center;}
    .btn{
      border:1px solid var(--br);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--txt);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      transition: transform .06s ease, filter .12s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
    }

    .card{
      border:1px solid var(--br);
      background:
        radial-gradient(600px 200px at 0% 0%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, var(--card1), var(--card2));
      border-radius: var(--r);
      padding:14px 14px 14px;
      margin:12px 0;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    h2{font-size:18px; margin:0 0 10px; letter-spacing:.2px;}
    label{display:block; font-size:12px; color:var(--mut); margin:10px 0 6px;}

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--txt);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    input::placeholder{color:rgba(159,177,193,.7)}
    .hint{color:var(--mut); font-size:12px; margin-top:8px;}
    .ok{color:var(--ok); font-size:12px; margin-top:8px;}
    .err{color:var(--bad); font-size:12px; margin-top:8px;}
    .small{font-size:12px; color:var(--mut); margin-top:8px;}

    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1 1 240px;}

    .progress{
      height:10px; border-radius:999px; border:1px solid var(--br);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .fill{height:100%; width:0%; background: var(--accent);}

    .places{margin-top:10px;}
    .place-item{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 10px;
      border:1px solid var(--br);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      margin-top:8px;
    }
    .place-main{flex:1}
    .place-title{font-weight:780; line-height:1.2;}
    .place-sub{color:var(--mut); font-size:12px; margin-top:4px;}
    .pill{
      display:inline-block; padding:3px 8px; border:1px solid var(--br);
      border-radius:999px; font-size:11px; color:var(--mut); margin-left:6px;
      background: rgba(255,255,255,.03);
    }
    .linkrow{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;}
    .linkrow a{
      color:var(--txt); text-decoration:none; border:1px solid var(--br);
      border-radius:999px; padding:4px 8px; font-size:12px;
      background: rgba(255,255,255,.04);
    }

    input[type="checkbox"]{
      width:20px; height:20px; margin-top:2px; accent-color: rgba(255,255,255,.85);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">üìä</div>
        <div>
          <h1>AstraBot</h1>
          <p class="subtitle">AI-–∞–Ω–∞–ª–∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞</p>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn" id="btnPro" type="button">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</button>
      </div>
    </div>

    <section class="card" id="accessCard">
      <h2>–î–æ—Å—Ç—É–ø</h2>
      <label for="token">–ê–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω</label>
      <input id="token" type="password" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ X-Admin-Token" autocomplete="off"/>
      <button class="btn" id="btnSaveToken" type="button" style="margin-top:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="hint">–•—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</div>
      <div class="err" id="tokenErr" style="display:none;"></div>
      <div class="ok" id="tokenOk" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>1) –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞</h2>

      <label for="city">–ì–æ—Ä–æ–¥</label>
      <input id="city" value="–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å" />

      <label for="niches">–ù–∏—à–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
      <input id="niches" value="—à–∫–æ–ª–∞ —Ç–∞–Ω—Ü–µ–≤" />

      <label for="depth">–ì–ª—É–±–∏–Ω–∞ –æ–±–∑–æ—Ä–∞</label>
      <select id="depth">
        <option value="10">–ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä (–¥–æ 10)</option>
        <option value="30" selected>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–æ 30)</option>
        <option value="50">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–æ 50)</option>
      </select>

      <button class="btn primary" id="btnStart" type="button">–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>

      <div class="small" style="margin-top:10px;">
        –¢–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑: <b id="jobIdText">ID –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞</b>
      </div>
      <div class="err" id="startErr" style="display:none;"></div>
      <div class="ok" id="startOk" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>2) –ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
      <div id="progressText" class="small">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞‚Ä¶</div>
      <div class="progress" aria-label="progress"><div class="fill" id="progressFill"></div></div>
      <div class="small" id="progressMeta"></div>
      <button class="btn" id="btnGoSelect" type="button" style="margin-top:10px;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</button>
    </section>

    <section class="card" id="selectCard" style="display:none;">
      <h2>3) –í—ã–±–æ—Ä –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</h2>
      <div class="hint">–û—Ç–º–µ—Ç—å—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ–±–æ–≥–∞—Ç–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–ª—É–±–∂–µ.</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnSelectAll" type="button">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
        <button class="btn" id="btnUnselectAll" type="button">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
      </div>
      <div class="places" id="places"></div>
      <button class="btn primary" id="btnEnrichSelected" type="button" style="margin-top:12px;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
      <div class="err" id="selectErr" style="display:none;"></div>
      <div class="ok" id="selectOk" style="display:none;"></div>
    </section>
  </div>

<script>
(function(){
  const LS_KEY = "admin_token";
  let currentJobId = "";
  let pollTimer = null;
  let placesCache = [];

  function $(id){ return document.getElementById(id); }
  function show(id, msg){
    const el = $(id);
    if(!el) return;
    el.style.display = msg ? "block" : "none";
    if(msg) el.textContent = msg;
  }
  function setProgress(pct){
    pct = Math.max(0, Math.min(100, pct||0));
    $("progressFill").style.width = pct + "%";
  }

  function getToken(){ return (localStorage.getItem(LS_KEY) || "").trim(); }
  function setToken(t){ localStorage.setItem(LS_KEY, (t||"").trim()); }

  function getTgUserId(){
    try{
      // 1) Telegram initDataUnsafe (preferred)
      const id1 = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
      if(id1) return id1;

      // 2) Parse Telegram initData (desktop/webview edge cases)
      const initData = window.Telegram?.WebApp?.initData;
      if(initData && typeof initData === "string"){
        const params = new URLSearchParams(initData);
        const userStr = params.get("user");
        if(userStr){
          const userObj = JSON.parse(decodeURIComponent(userStr));
          if(userObj && userObj.id) return userObj.id;
        }
      }

      // 3) URL fallback (?uid=123 or ?tg_user_id=123)
      const qs = new URLSearchParams(window.location.search || "");
      const id3 = qs.get("tg_user_id") || qs.get("uid") || qs.get("user_id");
      if(id3 && String(id3).trim()) return String(id3).trim();

      return null;
    }catch(e){
      return null;
    }
  }

  function authHeaders(){
    const t = getToken();
    return t ? {"X-Admin-Token": t} : {};
  }

  async function apiFetch(url, opts){
    opts = opts || {};
    opts.headers = Object.assign({"Content-Type":"application/json"}, opts.headers||{}, authHeaders());
    const res = await fetch(url, opts);
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch(e){ data = {raw:text}; }
    if(!res.ok){
      const msg = (data && (data.detail || data.error || data.message)) ? (data.detail || data.error || data.message) : ("HTTP " + res.status);
      const err = new Error(msg);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  function saveToken(){
    const t = $("token").value.trim();
    setToken(t);
    show("tokenErr", t ? "" : "–¢–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω.");
    show("tokenOk", t ? "–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω." : "");
  }
  function loadTokenIntoUI(){ $("token").value = getToken(); }

  function parseNiches(raw){
    return (raw||"").split(",").map(s => s.trim()).filter(Boolean);
  }

  function mapErrorMessage(msg){
    const s = String(msg||"");
    if(s.includes("tg_user_id") && s.includes("required")){
      return "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å WebApp –∏–∑ –∫–Ω–æ–ø–∫–∏ –≤ –±–æ—Ç–µ. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è (Desktop), –¥–æ–±–∞–≤—å—Ç–µ –∫ —Å—Å—ã–ª–∫–µ –ø–∞—Ä–∞–º–µ—Ç—Ä ?uid=–í–ê–®_ID.";
    }
    return s;
  }

  async function startAnalysis(){
    show("startErr", "");
    show("startOk", "");

    const city = $("city").value.trim();
    const niches = parseNiches($("niches").value);
    const limit = parseInt($("depth").value, 10) || 30;

    if(!city){ show("startErr", "–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥."); return; }
    if(niches.length===0){ show("startErr", "–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –Ω–∏—à—É."); return; }

    const tgUserId = getTgUserId();
    if(!tgUserId){
      show("startErr", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å WebApp –∏–∑ –∫–Ω–æ–ø–∫–∏ –≤ –±–æ—Ç–µ. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è (Desktop), –¥–æ–±–∞–≤—å—Ç–µ –∫ —Å—Å—ã–ª–∫–µ –ø–∞—Ä–∞–º–µ—Ç—Ä ?uid=–í–ê–®_ID.");
      return;
    }

    $("jobIdText").textContent = "–ó–∞–ø—É—Å–∫–∞–µ–º‚Ä¶";
    $("progressText").textContent = "üîç –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞‚Ä¶";
    setProgress(2);
    $("progressMeta").textContent = "";

    const payload = {
      tg_user_id: tgUserId,
      city: city,
      query: niches[0],
      queries: niches,
      limit: limit
    };

    const data = await apiFetch("/api/leads/run_full_job", {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const jobId = data.job_id || data.id || data.jobId;
    if(!jobId) throw new Error("–ù–µ –ø–æ–ª—É—á–∏–ª–∏ ID –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");

    currentJobId = jobId;
    $("jobIdText").textContent = jobId;
    show("startOk", "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω.");
    startPolling();
  }

  function humanStage(pct){
    if(pct < 20) return "üîç –ò—â–µ–º –∫–æ–º–ø–∞–Ω–∏–∏‚Ä¶";
    if(pct < 70) return "üìä –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶";
    if(pct < 95) return "üì± –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö‚Ä¶";
    return "‚úÖ –ó–∞–≤–µ—Ä—à–∞–µ–º‚Ä¶";
  }

  async function pollOnce(){
    if(!currentJobId) return;
    const data = await apiFetch(`/api/admin/job/${currentJobId}`, { method:"GET" });
    const st = data.state || data.job_state || {};
    const total = Number(st.total || 0);
    const done = Number(st.done || 0);
    const failed = Number(st.failed || 0);

    let pct = 0;
    if(total > 0) pct = Math.round((done / total) * 100);
    else pct = (String(st.status||"").toLowerCase() === "completed") ? 100 : 5;

    setProgress(pct);
    $("progressText").textContent = humanStage(pct);

    if(total > 0){
      $("progressMeta").textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${done}/${total}` + (failed ? ` ‚Ä¢ –û—à–∏–±–æ–∫: ${failed}` : "");
    } else {
      $("progressMeta").textContent = "";
    }

    const status = String(st.status || data.status || "").toLowerCase();
    if((total>0 && done>=total) || status === "completed" || status === "done" || status === "finished"){
      $("progressText").textContent = "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω";
      setProgress(100);
      if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
    }
  }

  function startPolling(){
    if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
    pollOnce().catch(()=>{});
    pollTimer = setInterval(() => { pollOnce().catch(()=>{}); }, 4000);
  }

  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escapeAttr(s){ return escapeHtml(s); }

  function mkLinks(arr, label){
    if(!arr) return "";
    const list = Array.isArray(arr) ? arr : [arr];
    const first = list.filter(Boolean).slice(0,2);
    return first.map(u => `<a href="${escapeAttr(u)}" target="_blank" rel="noreferrer">${label}</a>`).join("");
  }

  function renderPlaces(list){
    const root = $("places");
    root.innerHTML = "";
    if(!list || list.length===0){
      root.innerHTML = '<div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ‚Äú–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤‚Äù.</div>';
      return;
    }
    for(const p of list){
      const title = p.title || p.name || p.place_title || p.place_name || "–ö–æ–º–ø–∞–Ω–∏—è";
      const addr = p.address || p.addr || p.place_address || "";
      const selected = (p.selected !== undefined) ? !!p.selected : true;
      const placeKey = p.place_key || p.placeKey || "";
      const tg = p.tg_links || [];
      const ig = p.ig_links || [];
      const site = p.site_urls || [];

      const el = document.createElement("div");
      el.className = "place-item";
      el.innerHTML = `
        <input type="checkbox" class="chk" ${selected ? "checked" : ""} data-place-key="${escapeHtml(placeKey)}"/>
        <div class="place-main">
          <div class="place-title">${escapeHtml(title)} ${p.source ? `<span class="pill">${escapeHtml(p.source)}</span>` : ""}</div>
          <div class="place-sub">${escapeHtml(addr)}</div>
          <div class="linkrow">
            ${mkLinks(site, "–°–∞–π—Ç")}
            ${mkLinks(tg, "TG")}
            ${mkLinks(ig, "IG")}
          </div>
        </div>
      `;
      root.appendChild(el);
    }
  }

  async function loadPlaces(){
    show("selectErr","");
    show("selectOk","");
    if(!currentJobId){ show("selectErr","–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑."); return; }

    $("selectCard").style.display = "block";
    $("selectCard").scrollIntoView({behavior:"smooth", block:"start"});

    let data = null;
    try{
      data = await apiFetch(`/api/admin/job/${currentJobId}/places`, {method:"GET"});
      placesCache = data.places || data || [];
    }catch(e){
      const job = await apiFetch(`/api/admin/job/${currentJobId}`, {method:"GET"});
      placesCache = job.places || job.mi_places || [];
    }

    renderPlaces(placesCache);
  }

  async function saveSelection(replace){
    const chks = Array.from(document.querySelectorAll(".chk"));
    const place_keys = chks.map(c => c.getAttribute("data-place-key")).filter(Boolean);
    const selected_place_keys = chks.filter(c => c.checked).map(c => c.getAttribute("data-place-key")).filter(Boolean);

    const payload = { replace: !!replace, place_keys, selected_place_keys };

    await apiFetch(`/api/admin/job/${currentJobId}/places/select`, {
      method:"POST",
      body: JSON.stringify(payload)
    });
  }

  async function applySelectAll(val){
    const chks = Array.from(document.querySelectorAll(".chk"));
    chks.forEach(c => c.checked = val);
    await saveSelection(true);
  }

  async function enrichSelected(){
    show("selectErr","");
    show("selectOk","");
    if(!currentJobId){ show("selectErr","–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑."); return; }

    try{
      await saveSelection(true);
    }catch(e){
      show("selectErr", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä: " + mapErrorMessage(e.message));
      return;
    }

    try{
      await apiFetch(`/api/admin/job/${currentJobId}/enrich_selected`, {
        method:"POST",
        body: JSON.stringify({})
      });
      show("selectOk","–ó–∞–ø—É—â–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π.");
      startPolling();
    }catch(e){
      show("selectErr", mapErrorMessage(e.message));
    }
  }

  function openPro(){
    alert("–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞. –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ AI-–∏–Ω—Å–∞–π—Ç—ã.");
  }

  document.addEventListener("DOMContentLoaded", () => {
    try{ window.Telegram?.WebApp?.ready?.(); }catch(e){}
    try{ window.Telegram?.WebApp?.expand?.(); }catch(e){}
    loadTokenIntoUI();
    $("btnSaveToken").addEventListener("click", saveToken);
    $("btnStart").addEventListener("click", () => startAnalysis().catch(e => show("startErr", mapErrorMessage(e.message))));
    $("btnGoSelect").addEventListener("click", () => loadPlaces().catch(e => show("selectErr", mapErrorMessage(e.message))));
    $("btnSelectAll").addEventListener("click", () => applySelectAll(true).catch(e => show("selectErr", mapErrorMessage(e.message))));
    $("btnUnselectAll").addEventListener("click", () => applySelectAll(false).catch(e => show("selectErr", mapErrorMessage(e.message))));
    $("btnEnrichSelected").addEventListener("click", enrichSelected);
    $("btnPro").addEventListener("click", openPro);

    if(!getToken()) show("tokenErr","–¢–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω.");
  });
})();
</script>
</body>
</html>
