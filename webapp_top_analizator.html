<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Top Analizator (Admin)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e6edf3}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .card{background:#0f1a33;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin:10px 0}
    input,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:#e6edf3}
    textarea{min-height:110px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    button{cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>div{flex:1;min-width:210px}
    .muted{color:#9fb1c1;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .err{color:#ff6b6b}
    .ok{color:#7ee787}
  </style>
</head>
<body>
<div class="wrap">
  <h2>üèÜ Top Analizator (Admin)</h2>

  <div class="card">
    <div class="row">
      <div>
        <label>Admin token (X-Admin-Token)</label>
        <input id="token" placeholder="–≤—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω"/>
        <div class="muted">–¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</div>
      </div>
      <div style="max-width:220px">
        <label>&nbsp;</label>
        <button onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button style="margin-top:8px" onclick="loadJobs()">–û–±–Ω–æ–≤–∏—Ç—å jobs</button>
      </div>
    </div>
    <div id="tokenHint" class="muted"></div>
  </div>

  <div class="card">
    <h3>–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ (run_full_job)</h3>
    <div class="row">
      <div>
        <label>–ì–æ—Ä–æ–¥</label>
        <input id="city" value="–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å"/>
      </div>
      <div>
        <label>–ù–∏—à–∞</label>
        <input id="niche" value="—à–∫–æ–ª–∞ —Ç–∞–Ω—Ü–µ–≤"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Limit</label>
        <input id="limit" type="number" value="5"/>
      </div>
      <div>
        <label>Yandex retries</label>
        <input id="yandex_retries" type="number" value="0"/>
      </div>
      <div style="max-width:220px">
        <label>&nbsp;</label>
        <button onclick="runJob()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
    <div id="runOut" class="muted"></div>
  </div>

  <div class="card">
    <h3>Jobs</h3>
    <div id="jobsOut" class="muted">‚Äî</div>
  </div>

  <div class="card">
    <h3>Job detail</h3>
    <div class="row">
      <div>
        <label>Job ID</label>
        <input id="jobId" placeholder="–≤—Å—Ç–∞–≤—å job_id –∏ –Ω–∞–∂–º–∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å"/>
      </div>
      <div style="max-width:220px">
        <label>&nbsp;</label>
        <button onclick="loadJob()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button style="margin-top:8px" onclick="extractSocials()">Extract TG/IG</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>State</label>
        <textarea id="stateOut" readonly>{}</textarea>
      </div>
      <div>
        <label>Places (mi_places)</label>
        <textarea id="placesOut" readonly>[]</textarea>
      </div>
    </div>

    <div>
      <label>Places table (TG/IG focus)</label>
      <div id="placesTable" class="muted">‚Äî</div>
    </div>
  </div>
</div>

<script>
const API = "/api/admin";
function getToken(){ return localStorage.getItem("admin_token") || ""; }
function saveToken(){
  const t = document.getElementById("token").value.trim();
  localStorage.setItem("admin_token", t);
  hint();
}
function hint(){
  const t = getToken();
  document.getElementById("token").value = t;
  document.getElementById("tokenHint").innerHTML = t ? "<span class='ok'>‚úì token —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>" : "<span class='err'>‚úó token –Ω–µ –∑–∞–¥–∞–Ω</span>";
}
hint();

async function apiFetch(path, opts={}){
  const headers = Object.assign({}, opts.headers || {}, {"X-Admin-Token": getToken()});
  const r = await fetch(API + path, Object.assign({}, opts, {headers}));
  const text = await r.text();
  let data = null;
  try { data = JSON.parse(text); } catch(e) {}
  if(!r.ok){
    throw new Error((data && (data.detail||data.error)) ? (data.detail||data.error) : text);
  }
  return data;
}

async function loadJobs(){
  try{
    const data = await apiFetch("/jobs?limit=50");
    const jobs = data.jobs || [];
    if(!jobs.length){ document.getElementById("jobsOut").innerText = "–ø–æ–∫–∞ –ø—É—Å—Ç–æ"; return; }
    let html = "<table><thead><tr><th>Updated</th><th>Status</th><th>Progress</th><th>Job ID</th></tr></thead><tbody>";
    for(const j of jobs){
      const upd = j.updated_at || "";
      const st = j.status || "";
      const prog = (j.done||0)+"/"+(j.total||0)+" (failed "+(j.failed||0)+")";
      html += `<tr><td>${upd}</td><td><span class="pill">${st}</span></td><td>${prog}</td><td><a href="#" onclick="pickJob('${j.job_id}');return false;">${j.job_id}</a></td></tr>`;
    }
    html += "</tbody></table>";
    document.getElementById("jobsOut").innerHTML = html;
  }catch(e){
    document.getElementById("jobsOut").innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

function pickJob(id){
  document.getElementById("jobId").value = id;
  loadJob();
}

async function runJob(){
  const payload = {
    tg_user_id: 1,
    city: document.getElementById("city").value.trim(),
    niche: document.getElementById("niche").value.trim(),
    limit: parseInt(document.getElementById("limit").value||"0",10) || 5,
    yandex_retries: parseInt(document.getElementById("yandex_retries").value||"0",10) || 0
  };
  try{
    const data = await apiFetch("/run_job", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
    document.getElementById("runOut").innerText = "OK: "+JSON.stringify(data);
    if(data && data.job_id){ document.getElementById("jobId").value = data.job_id; }
    await loadJobs();
  }catch(e){
    document.getElementById("runOut").innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

async function loadJob(){
  const id = document.getElementById("jobId").value.trim();
  if(!id) return;
  try{
    const data = await apiFetch("/job/"+encodeURIComponent(id)+"?include_raw=false");
    document.getElementById("stateOut").value = JSON.stringify(data.state||{}, null, 2);
    document.getElementById("placesOut").value = JSON.stringify(data.places||[], null, 2);
    renderPlacesTable(data.places||[]);
  }catch(e){
    document.getElementById("stateOut").value = "{}";
    document.getElementById("placesOut").value = "[]";
    document.getElementById("placesTable").innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

function renderPlacesTable(places){
  if(!places.length){ document.getElementById("placesTable").innerText = "‚Äî"; return; }
  let html = "<table><thead><tr><th>place_key</th><th>site</th><th>Telegram</th><th>Instagram</th><th>other socials</th></tr></thead><tbody>";
  for(const p of places){
    const pk = p.place_key || "";
    const sites = (p.site_urls||[]);
    const site = Array.isArray(sites) ? (sites[0]||"") : (sites||"");
    const tg = (p.tg_links||[]);
    const ig = (p.ig_links||[]);
    const tgCell = Array.isArray(tg) && tg.length ? tg.map(u=>`<div><a href="${u}" target="_blank">${u}</a></div>`).join("") : "<span class='muted'>‚Äî</span>";
    const igCell = Array.isArray(ig) && ig.length ? ig.map(u=>`<div><a href="${u}" target="_blank">${u}</a></div>`).join("") : "<span class='muted'>‚Äî</span>";
    const other = (p.social_links||[]);
    const otherText = Array.isArray(other) ? other.filter(x=>typeof x==="string").slice(0,6).join("\n") : "";
    html += `<tr><td>${pk}</td><td>${site}</td><td>${tgCell}</td><td>${igCell}</td><td><pre style="white-space:pre-wrap;margin:0">${otherText||""}</pre></td></tr>`;
  }
  html += "</tbody></table>";
  document.getElementById("placesTable").innerHTML = html;
}

async function extractSocials(){
  const id = document.getElementById("jobId").value.trim();
  if(!id) return;
  try{
    const data = await apiFetch("/extract_socials", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({job_id:id, taplink_fetch:true})});
    alert("Updated: "+data.updated+" (errors: "+(data.errors||[]).length+")");
    await loadJob();
  }catch(e){
    alert("ERR: "+e.message);
  }
}
</script>
</body>
</html>
