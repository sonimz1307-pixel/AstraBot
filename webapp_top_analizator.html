<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AstraBot ‚Äî –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ (Admin)</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--br:rgba(255,255,255,.10);--txt:#e6edf3;--mut:#9fb1c1;--ok:#7ee787;--bad:#ff6b6b;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1060px;margin:0 auto;padding:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btnlink{background:transparent;border:1px solid var(--br);color:var(--txt);padding:8px 10px;border-radius:12px;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--br);border-radius:16px;padding:14px;margin:12px 0}
    h2,h3{margin:0 0 10px 0}
    label{display:block;font-size:13px;color:var(--mut);margin:0 0 6px 2px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--br);background:#0b1220;color:var(--txt);box-sizing:border-box}
    textarea{min-height:90px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    button{cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>div{flex:1;min-width:220px}
    .muted{color:var(--mut);font-size:13px}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;text-align:left;vertical-align:top}
    th{color:var(--mut);font-size:12px;font-weight:600}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions button{width:auto}
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{max-width:520px;width:100%;background:var(--card);border:1px solid var(--br);border-radius:18px;padding:16px}
  
  .subtitle{margin-top:6px;color:var(--muted);font-size:14px}
  .top-actions{display:flex;gap:10px;align-items:center}
  .icon-btn{width:44px;height:44px;border-radius:14px;border:1px solid var(--br);background:rgba(0,0,0,.15);color:var(--fg);font-size:18px;cursor:pointer}
  .icon-btn:active{transform:translateY(1px)}
  .progress-bar{width:100%;height:12px;border-radius:999px;border:1px solid var(--br);background:rgba(255,255,255,.06);overflow:hidden;margin-top:10px}
  .progress-fill{height:100%;width:0%;background:linear-gradient(90deg, rgba(138,180,248,.9), rgba(168,199,250,.9));}

</style>
</head>
<body>

    <section class="card" id="accessCard">
      <h2>–î–æ—Å—Ç—É–ø</h2>
      <div class="row">
        <label for="adminToken">–ê–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω</label>
        <input id="adminToken" type="password" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ X-Admin-Token" autocomplete="off"/>
        <button class="btn" onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div class="hint">–•—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</div>
        <div class="err" id="tokenErr" style="display:none;"></div>
        <div class="ok" id="tokenOk" style="display:none;"></div>
      </div>
    </section>

<div class="wrap">
  <div class="topbar">
    <div>
      <h2>üìä AstraBot ‚Äî –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</h2>
      <div class="subtitle">AI-–¥–≤–∏–∂–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞</div>
    </div>
    <div class="top-actions">
      <button class="btnlink" onclick="openModal()">–û—Ç–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É</button>
</div>
  </div>

  <div class="card">
    <h3>1) –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞</h3>
    <div class="row">
      <div>
        <label>–ì–æ—Ä–æ–¥</label>
        <input id="city" value="–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å"/>
      </div>
      <div>
        <label>–ù–∏—à–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
        <input id="niches" value="—à–∫–æ–ª–∞ —Ç–∞–Ω—Ü–µ–≤"/>
</div>
      <div style="max-width:260px">
        <label>–ì–ª—É–±–∏–Ω–∞ –æ–±–∑–æ—Ä–∞</label>
        <select id="depth">
          <option value="10">–ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä (–¥–æ 10)</option>
          <option value="30" selected>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–æ 30)</option>
          <option value="50">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–æ 50)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div style="max-width:260px">
        <label>&nbsp;</label>
        <button onclick="startAnalysis()">–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
      </div>
      <div>
        <label>–¢–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑</label>
        <input id="jobId" placeholder="ID –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞" readonly/>
      </div>
    </div>
    <div id="runOut" class="muted"></div>
  </div>

  <div class="card" id="progressCard">
    <h3>2) –ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
    <div id="progressStatus">
      <div id="progressText" class="muted">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞‚Ä¶</div>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressNumbers" class="muted" style="margin-top:10px"></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="openSelection()">–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</button>
    </div>
  </div>

  <div class="card hidden" id="selectCard">
    <h3>3) –í—ã–±–æ—Ä –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</h3>
    <div class="muted">–û—Ç–º–µ—Ç—å –Ω—É–∂–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ ‚Äî –¥–∞–ª—å–Ω–µ–π—à–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º.</div>
    <div class="actions" style="margin:10px 0">
      <button onclick="selectAll(true)">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
      <button onclick="selectAll(false)">–°–Ω—è—Ç—å –≤—Å–µ—Ö</button>
      <button onclick="saveSelection()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä</button>
    </div>
    <div style="margin:10px 0">
      <label>–ü–æ–∏—Å–∫</label>
      <input id="search" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ / —Ä–∞–π–æ–Ω" oninput="loadPlaces()"/>
    </div>
    <div id="placesTable" class="muted">‚Äî</div>
    <div class="actions" style="margin-top:10px">
      <button onclick="runEnrichSelected()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
    </div>
    <div id="enrichOut" class="muted" style="margin-top:10px"></div>
  </div>



  <div class="card hidden" id="settingsPanel">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞</h3>
    <div class="row">
      <div>
        <label>–ê–¥–º–∏–Ω‚Äë—Ç–æ–∫–µ–Ω</label>
        <input id="token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ X-Admin-Token"/>
        <div class="muted">–•—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
      </div>
      <div style="max-width:260px">
        <label>&nbsp;</label>
        <button onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
    <div id="tokenHint" class="muted"></div>
  </div>

</div>

<div class="modalBack" id="modalBack" onclick="closeModal(event)">
  <div class="modal">
    <h3>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
    <div class="muted" style="margin:8px 0 14px 0">
      –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —Å–∫–æ—Ä–æ ‚Äî —Ç–∞–º –ø–æ—è–≤—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ AI‚Äë–∏–Ω—Å–∞–π—Ç—ã.
    </div>
    <button onclick="closeModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
  </div>
</div>

<script>
const API = "/api/admin";
let progressInterval = null;

function getToken(){ return localStorage.getItem("admin_token") || ""; }
function saveToken(){
  const t = document.getElementById("token").value.trim();
  localStorage.setItem("admin_token", t);
  hint();
}

);
  }
}

}
function hint(){
  const t = getToken();
  document.getElementById("token").value = t;
  document.getElementById("tokenHint").innerHTML = t ? "–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω." : "<span class='bad'>–¢–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω.</span>";
}
hint();


function toggleSettings(){
  const el = document.getElementById("settingsPanel");
  if(!el) return;
  el.classList.toggle("hidden");
  // –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏
  if(!el.classList.contains("hidden")){
    el.scrollIntoView({behavior:"smooth", block:"start"});
  }
}


function headers(){
  const t = getToken();
  if(!t) throw new Error("admin token is empty");
  return {"Content-Type":"application/json","X-Admin-Token":t};
}

function openModal(){ document.getElementById("modalBack").style.display="flex"; }
function closeModal(e){
  if(e && e.target && e.target.id !== "modalBack") return;
  document.getElementById("modalBack").style.display="none";
}

function setJob(id){
  document.getElementById("jobId").value = id || "";
  if(id){ localStorage.setItem("last_job_id", id); }
}
(function(){
  const last = localStorage.getItem("last_job_id");
  if(last) setJob(last);
})();

async function startAnalysis(){
  try{
    const city = document.getElementById("city").value.trim();
    const niches = document.getElementById("niches").value.split(",").map(s=>s.trim()).filter(Boolean);
    const depth = parseInt(document.getElementById("depth").value,10);

    if(!city) return out("runOut","<span class='bad'>–£–∫–∞–∂–∏ –≥–æ—Ä–æ–¥.</span>");
    if(!niches.length) return out("runOut","<span class='bad'>–£–∫–∞–∂–∏ –Ω–∏—à—É.</span>");

    const payload = {tg_user_id: 1, city: city, niche: niches[0], limit: depth, yandex_retries: 1};

    out("runOut","–ó–∞–ø—É—Å–∫–∞—é –∞–Ω–∞–ª–∏–∑‚Ä¶");
    const r = await fetch(API+"/run_job", {method:"POST", headers:headers(), body:JSON.stringify(payload)});
    const j = await r.json();
    if(!r.ok || !j.ok) return out("runOut","<span class='bad'>–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: "+escapeHtml(JSON.stringify(j))+"</span>");
    setJob(j.job_id);
    out("runOut","‚úÖ –ó–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω: <span class='pill'>"+j.job_id+"</span>");
    startProgressPolling(j.job_id);
  }catch(e){
    out("runOut","<span class='bad'>"+escapeHtml(String(e))+"</span>");
  }
}

function phaseLabel(state){
  const meta = (state && state.meta) || {};
  const phase = (meta.phase || state.status || "").toString();
  // –ú–∞–≥–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –±–µ–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  if(phase.includes("queued")) return "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶";
  if(phase.includes("yandex")) return "–°–±–æ—Ä –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö‚Ä¶";
  if(phase.includes("done") || phase.includes("finished")) return "–ì–æ—Ç–æ–≤–æ";
  return phase ? phase : "–í —Ä–∞–±–æ—Ç–µ‚Ä¶";
}

async 
function updateProgressUI(st){
  const total = st?.total ?? 0;
  const done = st?.done ?? 0;
  const failed = st?.failed ?? 0;
  let pct = total>0 ? Math.min(100, Math.round((done/total)*100)) : 0;

  // –¢–µ–∫—Å—Ç ‚Äú–º–∞–≥–∏—á–µ—Å–∫–∏–º–∏‚Äù —Ñ–∞–∑–∞–º–∏
  let text = "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞‚Ä¶";
  if(total===0 && done===0){
    text = "üîç –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑‚Ä¶";
  }else if(pct < 30){
    text = "üîç –ò—â–µ–º –∫–æ–º–ø–∞–Ω–∏–∏‚Ä¶";
  }else if(pct < 70){
    text = "üìä –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶";
  }else if(pct < 100){
    text = "üì± –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö‚Ä¶";
  }else{
    text = "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω";
  }

  const fill = document.getElementById("progressFill");
  const txt = document.getElementById("progressText");
  const nums = document.getElementById("progressNumbers");
  if(fill) fill.style.width = pct + "%";
  if(txt) txt.innerText = text;
  if(nums){
    if(total>0){
      nums.innerHTML = "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: <b>"+done+"</b> / <b>"+total+"</b> &nbsp; –û—à–∏–±–æ–∫: <b>"+failed+"</b> &nbsp; ("+pct+"%)";
    }else{
      nums.innerHTML = "";
    }
  }
}

function stopProgressPolling(){
  if(progressInterval){
    clearInterval(progressInterval);
    progressInterval = null;
  }
}

function startProgressPolling(jobId){
  stopProgressPolling();
  // —Å—Ä–∞–∑—É –æ–¥–∏–Ω —Ä–∞–∑
  pollNow();
  // –¥–∞–ª—å—à–µ —Ä–∞–∑ –≤ 4 —Å–µ–∫—É–Ω–¥—ã
  progressInterval = setInterval(pollNow, 4000);
}

function pollNow(){
  const jobId = document.getElementById("jobId").value.trim();
  if(!jobId){
    updateProgressUI({total:0, done:0, failed:0});
    return;
  }
  fetch(API+"/job/"+encodeURIComponent(jobId), {headers:headers()})
    .then(async (r)=>({r, j: await r.json()}))
    .then(({r,j})=>{
      if(!r.ok || !j.ok){
        document.getElementById("progressText").innerText = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å";
        document.getElementById("progressNumbers").innerHTML = "<span class='bad'>–û—à–∏–±–∫–∞: "+escapeHtml(JSON.stringify(j))+"</span>";
        return;
      }
      const st = j.state || {};
      updateProgressUI(st);
      const total = st.total ?? 0;
      const done = st.done ?? 0;
      if(total>0 && done>=total){
        stopProgressPolling();
      }
    })
    .catch((e)=>{
      document.getElementById("progressText").innerText = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å";
      document.getElementById("progressNumbers").innerHTML = "<span class='bad'>"+escapeHtml(String(e))+"</span>";
    });
}

);
    const j = await r.json();
    if(!r.ok || !j.ok) return out("progressOut","<span class='bad'>–û—à–∏–±–∫–∞: "+escapeHtml(JSON.stringify(j))+"</span>");

    const st = j.state || {};
    const total = st.total ?? 0;
    const done = st.done ?? 0;
    const failed = st.failed ?? 0;
    const status = phaseLabel(st);

    let pct = total>0 ? Math.min(100, Math.round((done/total)*100)) : 0;

    out("progressOut",
      "<div class='pill'>"+escapeHtml(status)+"</div> "+
      "<div style='margin-top:10px'>"+
      "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: <b>"+done+"</b> / <b>"+total+"</b> &nbsp; –û—à–∏–±–æ–∫: <b>"+failed+"</b> &nbsp; ("+pct+"%)"+
      "</div>"
    );
  }catch(e){
    out("progressOut","<span class='bad'>"+escapeHtml(String(e))+"</span>");
  }
}

function openSelection(){
  document.getElementById("selectCard").classList.remove("hidden");
  loadPlaces();
  window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
}

let placesCache = [];
async function loadPlaces(){
  const jobId = document.getElementById("jobId").value.trim();
  if(!jobId) return;
  const search = document.getElementById("search").value.trim();
  try{
    const url = API+"/job/"+encodeURIComponent(jobId)+"/places?limit=2000&search="+encodeURIComponent(search);
    const r = await fetch(url, {headers:headers()});
    const j = await r.json();
    if(!r.ok || !j.ok) return out("placesTable","<span class='bad'>–û—à–∏–±–∫–∞: "+escapeHtml(JSON.stringify(j))+"</span>");
    placesCache = j.places || [];
    renderPlaces();
  }catch(e){
    out("placesTable","<span class='bad'>"+escapeHtml(String(e))+"</span>");
  }
}

function renderPlaces(){
  if(!placesCache.length) return out("placesTable","–ü–æ–∫–∞ –Ω–µ—Ç —Å–ø–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –í–µ—Ä–Ω–∏—Å—å –Ω–∞ —à–∞–≥ 2 –∏ –æ–±–Ω–æ–≤–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å.");
  let html = "<table><thead><tr>"+
    "<th></th><th>–ö–æ–º–ø–∞–Ω–∏—è</th><th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th><th>–°—Å—ã–ª–∫–∏</th></tr></thead><tbody>";
  for(const p of placesCache){
    const checked = p.selected ? "checked" : "";
    const title = p.title || ("place_key "+p.place_key);
    const addr = p.address || "";
    const tg = p.tg ? "<div>üì® <a href='"+escapeAttr(p.tg)+"' target='_blank'>Telegram</a></div>" : "<div class='muted'>Telegram: ‚Äî</div>";
    const ig = p.ig ? "<div>üì∑ <a href='"+escapeAttr(p.ig)+"' target='_blank'>Instagram</a></div>" : "<div class='muted'>Instagram: ‚Äî</div>";
    const site = p.website ? "<div>üåê <a href='"+escapeAttr(p.website)+"' target='_blank'>–°–∞–π—Ç</a></div>" : "<div class='muted'>–°–∞–π—Ç: ‚Äî</div>";

    html += "<tr>"+
      "<td><input type='checkbox' data-pk='"+escapeAttr(p.place_key)+"' "+checked+" onchange='toggleOne(this)'/></td>"+
      "<td><div><b>"+escapeHtml(title)+"</b></div><div class='muted'>"+escapeHtml(addr)+"</div><div class='muted'>"+escapeHtml(p.place_key)+"</div></td>"+
      "<td>"+site+"</td>"+
      "<td>"+tg+ig+"</td>"+
    "</tr>";
  }
  html += "</tbody></table>";
  out("placesTable", html);
}

function toggleOne(cb){
  const pk = cb.getAttribute("data-pk");
  const v = cb.checked;
  for(const p of placesCache){
    if(p.place_key===pk){ p.selected = v; break; }
  }
}

function selectAll(v){
  for(const p of placesCache){ p.selected = !!v; }
  renderPlaces();
}

async function saveSelection(){
  const jobId = document.getElementById("jobId").value.trim();
  if(!jobId) return;

  const keys = placesCache.filter(p=>p.selected).map(p=>p.place_key);
  try{
    out("enrichOut","–°–æ—Ö—Ä–∞–Ω—è—é –≤—ã–±–æ—Ä‚Ä¶");
    const payload = {place_keys: keys, selected: true, replace: true};
    const r = await fetch(API+"/job/"+encodeURIComponent(jobId)+"/places/select", {
      method:"POST", headers:headers(), body:JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok || !j.ok) return out("enrichOut","<span class='bad'>–û—à–∏–±–∫–∞: "+escapeHtml(JSON.stringify(j))+"</span>");
    out("enrichOut","‚úÖ –í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –í—ã–±—Ä–∞–Ω–æ: <b>"+keys.length+"</b>");
  }catch(e){
    out("enrichOut","<span class='bad'>"+escapeHtml(String(e))+"</span>");
  }
}

async function runEnrichSelected(){
  const jobId = document.getElementById("jobId").value.trim();
  if(!jobId) return;
  try{
    out("enrichOut","–ó–∞–ø—É—Å–∫–∞—é –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö‚Ä¶");
    const r = await fetch(API+"/job/"+encodeURIComponent(jobId)+"/enrich_selected", {
      method:"POST",
      headers:headers(),
      body:JSON.stringify({max_urls_per_place: 5, timeout_sec: 25.0, write_raw: true})
    });
    const j = await r.json();
    if(!r.ok || !j.ok) return out("enrichOut","<span class='bad'>–û—à–∏–±–∫–∞: "+escapeHtml(JSON.stringify(j))+"</span>");
    out("enrichOut","‚úÖ –ì–æ—Ç–æ–≤–æ. –û–±–Ω–æ–≤–ª–µ–Ω–æ: <b>"+(j.updated||0)+"</b>. –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π: <b>"+(j.scanned_places||0)+"</b>.");
    // refresh list to show TG/IG
    loadPlaces();
  }catch(e){
    out("enrichOut","<span class='bad'>"+escapeHtml(String(e))+"</span>");
  }
}

function out(id, html){ document.getElementById(id).innerHTML = html; }
function escapeHtml(s){ return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function escapeAttr(s){ return escapeHtml(s).replaceAll("'","%27").replaceAll('"',"%22"); }
</script>
</body>
</html>
